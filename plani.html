<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EnvÃ­o de Planificaciones (Links)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full bg-white rounded-xl shadow-xl overflow-hidden">
        <div class="bg-green-700 p-6 text-center">
            <h1 class="text-white text-2xl font-bold">EnvÃ­o de Enlaces</h1>
            <p class="text-green-100 text-sm">Plataforma de Contingencia UTP 2025</p>
        </div>

        <div class="p-8 space-y-4">
            
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Docente</label>
                <select id="input-docente" class="w-full border-2 border-gray-200 p-3 rounded-lg bg-white focus:border-green-500 outline-none">
                    <option value="">Cargando lista...</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Curso / Nivel</label>
                <select id="input-curso" class="w-full border-2 border-gray-200 p-3 rounded-lg bg-white focus:border-green-500 outline-none">
                    <option value="">Cargando lista...</option>
                </select>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Asignatura</label>
                <input type="text" id="input-asignatura" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-green-500 outline-none" placeholder="Ej: MatemÃ¡tica, OrientaciÃ³n...">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">TÃ­tulo / Mes</label>
                <input type="text" id="input-titulo" class="w-full border-2 border-gray-200 p-3 rounded-lg focus:border-green-500 outline-none" placeholder="Ej: Marzo - Unidad 1">
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Link del Archivo (Drive/Dropbox)</label>
                <input type="url" id="input-link" class="w-full border-2 border-gray-200 p-3 rounded-lg text-blue-600 focus:border-green-500 outline-none" placeholder="https://...">
            </div>

            <button id="btn-enviar" class="w-full bg-green-700 text-white font-bold py-4 rounded-lg hover:bg-green-800 transition flex justify-center items-center gap-2 shadow-lg mt-4">
                <span id="btn-text">ðŸš€ Enviar a UTP</span>
            </button>

            <div id="mensaje-exito" class="hidden mt-4 p-3 bg-green-100 text-green-800 text-center rounded-lg text-sm font-bold border border-green-200">
                âœ… Â¡Recibido! Tu planificaciÃ³n ha sido registrada en el sistema.
            </div>

        </div>
        <div class="bg-gray-50 p-4 text-center text-xs text-gray-400 border-t">
            Escuela AgrÃ­cola Sagrados Corazones
        </div>
    </div>

    <script>
        // 1. CONFIGURACIÃ“N BITÃCORA (Para leer listas)
        const configBitacora = { apiKey: "AIzaSyDUArOBUzzvulHYQGA7IvnEwo2jQbEa3Xs", authDomain: "attendance-ai-s81lt.firebaseapp.com", projectId: "attendance-ai-s81lt", storageBucket: "attendance-ai-s81lt.firebasestorage.app", messagingSenderId: "935781953186", appId: "1:935781953186:web:6c8a7a93ffad180d33b1fb" };
        const appBitacora = firebase.initializeApp(configBitacora, "appBitacora");
        const dbBitacora = appBitacora.firestore();

        // 2. CONFIGURACIÃ“N PLANIFICACIONES (Para guardar)
        const configPlanif = { apiKey: "AIzaSyDJnJlpsqR76z_lBnTNEULYcGoQGIi23VU", authDomain: "planificaciones-18b94.firebaseapp.com", projectId: "planificaciones-18b94", storageBucket: "planificaciones-18b94.appspot.com", messagingSenderId: "268119843295", appId: "1:268119843295:web:bb2bdbcb0affe4ecf3646a" };
        const appPlanif = firebase.initializeApp(configPlanif, "appPlanif");
        const dbPlanif = appPlanif.firestore();

        // CARGAR LISTAS AL INICIAR
        document.addEventListener("DOMContentLoaded", async () => {
            const selDocente = document.getElementById('input-docente');
            const selCurso = document.getElementById('input-curso');

            try {
                // Cargar Docentes
                const docSnap = await dbBitacora.collection('docentes').get();
                const docentes = docSnap.docs.map(d => d.data().nombre).sort();
                
                selDocente.innerHTML = '<option value="">-- Seleccionar Docente --</option>';
                docentes.forEach(d => {
                    selDocente.innerHTML += `<option value="${d}">${d}</option>`;
                });

                // Cargar Cursos (Niveles Ãºnicos)
                const curSnap = await dbBitacora.collection('cursos').get();
                const niveles = [...new Set(curSnap.docs.map(d => d.data().nivel))].sort();
                
                selCurso.innerHTML = '<option value="">-- Seleccionar Curso --</option>';
                niveles.forEach(n => {
                    selCurso.innerHTML += `<option value="${n}">${n}</option>`;
                });

            } catch (e) {
                console.error("Error cargando listas:", e);
                selDocente.innerHTML = '<option>Error de conexiÃ³n</option>';
            }
        });

        // ENVIAR
        document.getElementById('btn-enviar').addEventListener('click', async () => {
            const docente = document.getElementById('input-docente').value;
            const curso = document.getElementById('input-curso').value;
            const asignatura = document.getElementById('input-asignatura').value.trim();
            const titulo = document.getElementById('input-titulo').value.trim();
            const link = document.getElementById('input-link').value.trim();

            if(!docente || !curso || !asignatura || !titulo) {
                alert("âš ï¸ Por favor completa los campos obligatorios.");
                return;
            }

            const btn = document.getElementById('btn-enviar');
            const btnText = document.getElementById('btn-text');
            const originalText = btnText.innerText;
            
            btn.disabled = true;
            btnText.innerText = "Enviando...";
            btn.classList.add('opacity-50');

            try {
                // Guardar en la MISMA colecciÃ³n que el planificador digital
                // Esto hace que aparezca en el Control UTP automÃ¡ticamente
                await dbPlanif.collection('planificaciones_digitales').add({
                    docente: docente,
                    curso: curso,           // Guardamos como 'curso' o 'nivel' segÃºn convenga, el Control lee ambos
                    nivel: curso,           // Duplicamos para asegurar compatibilidad
                    asignatura: asignatura,
                    mes_planificado: titulo, // El control leerÃ¡ esto como el mes/unidad
                    link_externo: link,     
                    estado: 'Enviado UTP',
                    origen: 'link',         // Etiqueta clave para el visor
                    timestamp: Date.now(),
                    fecha_envio: new Date().toLocaleString()
                });

                document.getElementById('mensaje-exito').classList.remove('hidden');
                
                // Resetear campos visuales
                document.getElementById('input-titulo').value = '';
                document.getElementById('input-link').value = '';
                
                setTimeout(() => {
                    document.getElementById('mensaje-exito').classList.add('hidden');
                    btn.disabled = false;
                    btnText.innerText = originalText;
                    btn.classList.remove('opacity-50');
                }, 3000);

            } catch (error) {
                console.error("Error:", error);
                alert("Hubo un error al enviar. Verifica tu conexiÃ³n.");
                btn.disabled = false;
                btnText.innerText = originalText;
                btn.classList.remove('opacity-50');
            }
        });
    </script>
</body>
</html>