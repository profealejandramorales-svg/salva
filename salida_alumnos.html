<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Salidas - Inspector√≠a v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* ESTILOS DE IMPRESI√ìN */
        @media print {
            @page { size: auto; margin: 0mm; } 
            body * { visibility: hidden; }
            
            /* TICKET (Formato t√©rmico o recorte) */
            .print-area, .print-area * { visibility: visible; }
            .print-area {
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: Arial, sans-serif; color: #000; padding: 10px;
            }

            /* REPORTE (Hoja Carta) */
            .print-report, .print-report * { visibility: visible; }
            .print-report {
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: Arial, sans-serif; padding: 20px;
                background: white;
            }
            
            .no-print { display: none !important; }
            
            /* Forzar impresion de imagenes */
            img { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 flex flex-col items-center">
    
    <div class="w-full max-w-5xl bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-600 mb-6">
        <div class="flex flex-col items-center">
            <img src="logo.jpg" class="h-20 w-auto mb-2 object-contain" onerror="this.style.display='none'">
            <h1 class="text-3xl font-bold text-gray-800">Control de Salidas</h1>
            <p class="text-sm text-gray-500">Gesti√≥n de Retiros y Pases de Salida</p>
        </div>
        <div id="message-box" class="hidden mt-4 p-3 rounded text-center font-bold"></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full max-w-5xl">
        
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-xl font-bold text-indigo-800 mb-4 border-b pb-2">Nueva Autorizaci√≥n</h2>
            
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-indigo-600 uppercase">N¬∞ Folio Libro</label>
                        <input type="number" id="folio" placeholder="Ej: 1054" class="w-full border-2 border-indigo-100 p-2 rounded focus:border-indigo-500 outline-none font-bold text-lg">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase">Curso</label>
                        <select id="course" class="w-full border p-2 rounded bg-gray-50 h-[46px]">
                            <option value="">-- Seleccionar --</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Estudiante</label>
                    <select id="student" class="w-full border p-2 rounded bg-gray-50 disabled:bg-gray-200" disabled>
                        <option value="">-- Seleccionar --</option>
                    </select>
                </div>

                <div class="bg-indigo-50 p-4 rounded border border-indigo-100">
                    <p class="text-xs font-bold text-indigo-600 uppercase mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                        Adulto Responsable (Quien retira)
                    </p>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="col-span-2">
                            <input type="text" id="guardian-name" placeholder="Nombre Completo" class="w-full border p-2 rounded text-sm">
                        </div>
                        <div>
                            <input type="text" id="guardian-rut" placeholder="RUT" class="w-full border p-2 rounded text-sm">
                        </div>
                        <div>
                            <select id="guardian-rel" class="w-full border p-2 rounded text-sm">
                                <option value="Apoderado">Apoderado Titular</option>
                                <option value="Madre">Madre</option>
                                <option value="Padre">Padre</option>
                                <option value="Abuelo/a">Abuelo/a</option>
                                <option value="T√≠o/a">T√≠o/a</option>
                                <option value="Transporte">Transporte Escolar</option>
                                <option value="Otro">Otro (Autorizado)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase">Motivo</label>
                    <select id="reason" class="w-full border p-2 rounded mb-2">
                        <option value="M√©dico">Hora M√©dica/Dental</option>
                        <option value="Personal">Tr√°mite Personal/Familiar</option>
                        <option value="Enfermedad">Enfermedad (Enfermer√≠a)</option>
                        <option value="Emergencia">Emergencia Familiar</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <input type="text" id="reason-detail" placeholder="Detalle adicional (Opcional)" class="w-full border p-2 rounded text-sm">
                </div>

                <button id="btn-save" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded shadow transition flex justify-center items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-7a2 2 0 012-2h2m3-4H9a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-1m-1 4l-3 3m0 0l-3-3m3 3V3"></path></svg>
                    Generar Pase de Salida
                </button>
            </div>
        </div>

        <div class="space-y-6">
            
            <div class="bg-gray-50 p-6 rounded-xl border border-gray-300 flex flex-col items-center">
                <h3 class="text-gray-400 font-bold mb-4 uppercase text-xs">Ticket para Porter√≠a</h3>
                
                <div id="ticket-area" class="print-area bg-white p-4 shadow-md w-full max-w-sm border-2 border-dashed border-gray-400 hidden">
                    <div class="flex items-center justify-between border-b-2 border-black pb-2 mb-2">
                        <img src="logo.jpg" class="h-12 w-auto object-contain" onerror="this.style.display='none'">
                        <div class="text-right">
                            <h2 class="text-xl font-bold uppercase leading-none">Pase Salida</h2>
                            <p class="text-[10px] font-bold mt-1">Esc. Agr√≠cola Sagrados Corazones</p>
                            <p class="text-xs mt-1">Folio N¬∞: <span id="ticket-folio" class="font-mono font-bold text-lg">---</span></p>
                        </div>
                    </div>

                    <div class="text-left space-y-1 text-sm">
                        <p><strong>Fecha:</strong> <span id="ticket-date"></span></p>
                        <p><strong>Estudiante:</strong> <span id="ticket-student" class="uppercase font-bold"></span></p>
                        <p><strong>Curso:</strong> <span id="ticket-course"></span></p>
                        <hr class="border-gray-300 my-2">
                        <p><strong>Retirado por:</strong> <span id="ticket-guardian" class="uppercase"></span></p>
                        <p><strong>RUT:</strong> <span id="ticket-rut"></span> (<span id="ticket-rel"></span>)</p>
                        <p><strong>Motivo:</strong> <span id="ticket-reason"></span></p>
                    </div>

                    <div class="mt-8 pt-2 border-t border-black flex justify-between text-[10px]">
                        <div class="text-center w-1/2"><br>Firma Apoderado</div>
                        <div class="text-center w-1/2"><br>Firma Inspector√≠a</div>
                    </div>
                </div>
                
                <div id="ticket-placeholder" class="text-center text-gray-400 py-10">
                    <p>Complete el formulario para ver el ticket.</p>
                </div>

                <div id="action-buttons" class="mt-4 hidden w-full">
                    <button onclick="window.print()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded shadow mb-2">Imprimir Ticket</button>
                    <button onclick="resetForm()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded shadow">Nueva Salida</button>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">Generador de Reportes</h2>
                
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500">Desde</label>
                        <input type="date" id="report-start" class="w-full border p-1 rounded text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-gray-500">Hasta</label>
                        <input type="date" id="report-end" class="w-full border p-1 rounded text-sm">
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button id="btn-report-filter" class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-2 px-4 rounded flex-1">Buscar</button>
                    <button id="btn-report-today" class="bg-teal-600 hover:bg-teal-700 text-white text-sm font-bold py-2 px-4 rounded flex-1">Ver Hoy</button>
                </div>
            </div>

        </div>
    </div>

    <div id="report-result" class="w-full max-w-5xl mt-8 hidden print-report">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <div class="flex items-center gap-4">
                <img src="logo.jpg" class="h-16 w-auto object-contain" onerror="this.style.display='none'">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Reporte de Salidas</h2>
                    <p class="text-sm text-gray-600">Escuela Agr√≠cola Sagrados Corazones</p>
                </div>
            </div>
            <div class="no-print">
                <button onclick="window.print()" class="bg-gray-800 text-white px-4 py-2 rounded font-bold text-sm">üñ®Ô∏è Imprimir Reporte</button>
                <button onclick="closeReport()" class="text-red-500 font-bold text-sm ml-4 underline">Cerrar</button>
            </div>
        </div>
        
        <p class="text-sm text-gray-600 mb-4">Periodo: <span id="report-period-label" class="font-bold"></span></p>

        <table class="w-full text-left text-sm border-collapse">
            <thead>
                <tr class="bg-gray-200 border-b border-gray-400">
                    <th class="p-2 border border-gray-300">Folio</th>
                    <th class="p-2 border border-gray-300">Fecha/Hora</th>
                    <th class="p-2 border border-gray-300">Alumno</th>
                    <th class="p-2 border border-gray-300">Curso</th>
                    <th class="p-2 border border-gray-300">Retirado Por</th>
                    <th class="p-2 border border-gray-300">Motivo</th>
                </tr>
            </thead>
            <tbody id="report-table-body"></tbody>
        </table>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configuraci√≥n Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBnSMVCH0yyYUWk5z54kTIPTrWkyoeWs-I",
            authDomain: "suspenciones-40d0c.firebaseapp.com",
            projectId: "suspenciones-40d0c",
            storageBucket: "suspenciones-40d0c.firebasestorage.app",
            messagingSenderId: "853418739042",
            appId: "1:853418739042:web:d051befb99cd2acdd4583b",
            measurementId: "G-L00J7XN6Y1"
        };

        const COLLECTION_NAME = "salidas_alumnos"; 

        const schoolData = {
            'Primero Medio A': ['ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS', 'CONTRERAS SALGADO HADEEY ALEJANDRA', 'FERRADA ALBORNOZ AGUST√çN ALEXIS', 'HERN√ÅNDEZ FERN√ÅNDEZ DHARIEN ALEXSANDER', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA', 'LAGOS LASTRA ALEXANDRA DANAE', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO', 'MALDONADO FLORES ANTONELLA BEL√âN', 'MARIN MAR√çN IGNACIO ANTONIO', 'MONTECINO D√çAZ VALESKA BEL√âN', 'MU√ëOZ CONTRERAS LUIS GABRIEL', 'MU√ëOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ', 'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS', 'QUEZADA NARANJO FELIPE ALONSO', 'QUINTEROS VERGARA FERNANDA FLORENCIA', 'RAM√çREZ VILLALOBOS DUVAN EMILIO', 'SANTANDER L√ìPEZ MAR√çA JOS√â', 'TAPIA CASTILLA JEANFRANCO PATRICK', 'URBINA C√ÅCERES FRANCHESCA POULETTE', 'V√ÅSQUEZ ZALDUENDO AMANDA ISABEL', 'ZABALAGA COFR√â DAMI√ÅN ANDR√âS', 'BAEZ DONOSO LUKAS ALFONSO', 'MESA D√çAZ GONZALO IGNACIO', 'BAREA SALGADO SERGIO ALEXANDER'],
            'Primero Medio B': ['ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MU√ëOZ TRONCOSO H√âCTOR ANTONIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN'],
            'Segundo Medio A': ['AHUMADA ROJAS TRINIDAD BEL√âN', 'ESPINOSA TORRES FERNANDA ELENA', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS', 'GONZ√ÅLEZ SALAZAR EMILIA CATALINA', 'MEDEL OJEDA LE√ìN IGNACIO', 'MORALES REIM√ÅN ALFONSO TOM√ÅS', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO', 'PINTO TOBAR JORD√ÅN AMARO', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO', 'RIVERA ABARZA CONSTANZA VICTORIA', 'SANTIS CASSEUS TEIVA SCARLETT', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN', 'TOLEDO ALBORNOZ ANTONELLA INES', 'VENEGAS ARRIAGADA ANTONIA EDITH', 'VIELMA ZABALAGA JOAN MANUEL', 'MEZA COLIM√ÅN ANGEL BLAS', 'PALMA ORELLANA ANTONELLA FRANCISCA'],
            'Segundo Medio B': ['ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MU√ëOZ TRONCOSO H√âCTOR ANTONIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN'],
            'Tercero Medio A': ['ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA', 'BAHAMONDE MU√ëOZ ARIEL LEON', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS', 'CANCINO OR√ìSTICA VICENTE GASPAR', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA', 'COFR√â CASTILLO ANTONIO ANDR√âS', 'CONTRERAS VENEGAS BEL√âN ALEJANDRA', 'GALDAMES VERGARA FELIPE ESTEBAN', 'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN', 'JARA SEP√öLVEDA KATRINA DARINKA', 'MART√çNEZ LIZANA AARON ALEJANDRO', 'MEZA CARRASCO BENJAM√çN INTI', 'MI√ëO GONZALEZ CATALINA ANDREA', 'MORAGA PACHECO RENATO IGNACIO', 'P√âREZ COR√ìN MANUEL IGNACIO', 'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA', 'TAPIA ACU√ëA GABRIEL ANTONIO', 'VEGA VIVANCO CRIST√ìBAL ANTONIO', 'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA', 'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS', 'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO', 'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'CARO URRUTIA CONSUELO ANTONIA', 'LOBOS C√ÅCERES ANTONIA PAZ'],
            'Tercero Medio C': ['ARELLANO ACU√ëA MART√çN ANTONIO', 'AROS √ÅVILA DAYANA IGNACIA', 'CABRERA COLOMBINO MAR√çA GRACIA', 'FUENTES CARRASCO YARIXA ALEJANDRA', 'G√ìMEZ CANCINO DANIELA ALEJANDRA', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA', 'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAM√çN ESTEBAN', 'PALACIOS SOTO JOS√â TOM√ÅS', 'PEZO SANTANDER JOS√â CRIST√ìBAL', 'ROCHA ROJAS JOS√â PABLO WILLIAMS', 'ROJAS Y√âVENES FABIANA ISIDORA', 'S√ÅNCHEZ PAREJA ANDY ANTONIO', 'SANTANDER L√ìPEZ SIM√ìN ESTEBAN', 'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA', 'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN', 'COLLAO MEDINA ANA√çS VALENTINA'],
            'Cuarto Medio A': ['AGURTO CRESPO HOMERO ALEXANDER', 'ANDIA DE LA HOZ CATALINA BELEN', 'FUENTES GONZ√ÅLEZ ESTEBAN ALEXANDER', 'GARC√çA ROJAS SOF√çA ELENA', 'GODOY HERRERA ANTONELLA CONSTANZA PAZ', 'GONZ√ÅLEZ CASTRO KEVIN ALEJANDRO', 'MARCHANT MOR√ÅN P√çA IGNACIA', 'QUINTANA SAN MART√çN ALAN VICENTE', 'RECABAL Y√Å√ëEZ CRISTOFER BASTI√ÅN', 'ROJAS GONZ√ÅLEZ GABRIEL ANTONIO', 'TOLEDO MU√ëOZ ESPERANZA BEL√âN', 'Y√Å√ëEZ GONZ√ÅLEZ FRANCISCA ALEJANDRA'],
            'Cuarto Medio C': ['Josefa Morales', 'Benjam√≠n P√©rez', 'Constanza Varela'],
        };

        let db, auth;
        const courseSelect = document.getElementById('course');
        const studentSelect = document.getElementById('student');
        
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            populateDropdowns();
            
            document.getElementById('btn-save').addEventListener('click', saveExitPass);
            document.getElementById('btn-report-today').addEventListener('click', () => generateReport('today'));
            document.getElementById('btn-report-filter').addEventListener('click', () => generateReport('range'));
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('report-start').value = today;
            document.getElementById('report-end').value = today;

            window.resetForm = resetForm;
            window.closeReport = closeReport;
        });

        async function initApp() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await signInAnonymously(auth);
                console.log("Conectado");
            } catch (e) {
                console.error("Error conexi√≥n", e);
                showMessage("Modo Offline", "bg-yellow-100 text-yellow-700");
            }
        }

        function populateDropdowns() {
            for (const course in schoolData) {
                const opt = document.createElement('option');
                opt.value = course;
                opt.textContent = course;
                courseSelect.appendChild(opt);
            }
            courseSelect.addEventListener('change', () => {
                const sel = courseSelect.value;
                studentSelect.innerHTML = '<option value="">-- Seleccionar --</option>';
                studentSelect.disabled = !sel;
                if (sel && schoolData[sel]) {
                    schoolData[sel].forEach(st => {
                        const opt = document.createElement('option');
                        opt.value = st;
                        opt.textContent = st;
                        studentSelect.appendChild(opt);
                    });
                }
            });
        }

        async function saveExitPass() {
            const folio = document.getElementById('folio').value.trim();
            const course = courseSelect.value;
            const student = studentSelect.value;
            const guardian = document.getElementById('guardian-name').value.trim();
            const rut = document.getElementById('guardian-rut').value.trim();
            const rel = document.getElementById('guardian-rel').value;
            const reason = document.getElementById('reason').value;
            const detail = document.getElementById('reason-detail').value.trim();

            if (!folio || !course || !student || !guardian || !rut) {
                showMessage("Faltan datos obligatorios", "bg-red-100 text-red-700");
                return;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString('es-CL', {hour: '2-digit', minute:'2-digit'});
            const dateString = now.toLocaleDateString('es-CL');
            const isoDate = now.toISOString().split('T')[0];

            const record = {
                folio, course, student, guardian, rut, rel, 
                reason: detail ? `${reason} - ${detail}` : reason,
                timestamp: now.toISOString(),
                dateISO: isoDate,
                dateDisplay: dateString,
                timeDisplay: timeString
            };

            // Ticket UI
            document.getElementById('ticket-folio').textContent = folio;
            document.getElementById('ticket-student').textContent = student;
            document.getElementById('ticket-course').textContent = course;
            document.getElementById('ticket-guardian').textContent = guardian;
            document.getElementById('ticket-rel').textContent = rel;
            document.getElementById('ticket-rut').textContent = rut;
            document.getElementById('ticket-reason').textContent = record.reason;
            document.getElementById('ticket-date').textContent = `${dateString} ${timeString}`;

            document.getElementById('ticket-placeholder').classList.add('hidden');
            document.getElementById('ticket-area').classList.remove('hidden');
            document.getElementById('action-buttons').classList.remove('hidden');

            const btn = document.getElementById('btn-save');
            btn.disabled = true; btn.textContent = "Guardando...";

            try {
                await addDoc(collection(db, COLLECTION_NAME), record);
                showMessage("‚úÖ Guardado exitosamente", "bg-green-100 text-green-700");
            } catch (e) {
                console.error(e);
                showMessage("‚ö†Ô∏è Error al guardar", "bg-red-100 text-red-700");
            } finally {
                btn.disabled = false; btn.textContent = "Generar Pase de Salida";
            }
        }

        // FUNCI√ìN MEJORADA: Sin orderBy en query para evitar cualquier error de √≠ndice
        async function generateReport(type) {
            const tbody = document.getElementById('report-table-body');
            const reportDiv = document.getElementById('report-result');
            const label = document.getElementById('report-period-label');
            
            tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Cargando datos... Por favor espere.</td></tr>';
            reportDiv.classList.remove('hidden');
            
            let startDate, endDate;
            
            if (type === 'today') {
                startDate = new Date().toISOString().split('T')[0];
                endDate = startDate;
                label.textContent = `Hoy (${new Date().toLocaleDateString()})`;
            } else {
                startDate = document.getElementById('report-start').value;
                endDate = document.getElementById('report-end').value;
                label.textContent = `Desde ${startDate} hasta ${endDate}`;
            }

            try {
                // 1. Traer colecci√≥n simple (sin ordenar ni filtrar en servidor)
                const q = collection(db, COLLECTION_NAME);
                const snapshot = await getDocs(q);
                
                let data = [];
                snapshot.forEach(doc => {
                    const d = doc.data();
                    // 2. Filtrar en cliente (JavaScript)
                    let recordDate = d.dateISO;
                    if (!recordDate && d.timestamp) {
                        // Compatibilidad si faltara dateISO
                        recordDate = d.timestamp.split('T')[0]; 
                    }
                    
                    if (recordDate && recordDate >= startDate && recordDate <= endDate) {
                        data.push(d);
                    }
                });

                // 3. Ordenar en cliente (Descendente)
                data.sort((a, b) => {
                    const tA = a.timestamp || '';
                    const tB = b.timestamp || '';
                    return tB.localeCompare(tA);
                });

                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-gray-500">No se encontraron registros en este periodo.</td></tr>';
                } else {
                    data.forEach(d => {
                        const tr = document.createElement('tr');
                        tr.className = "border-b hover:bg-gray-50";
                        tr.innerHTML = `
                            <td class="p-2 border border-gray-300 font-bold">${d.folio || '-'}</td>
                            <td class="p-2 border border-gray-300">${d.dateDisplay} ${d.timeDisplay}</td>
                            <td class="p-2 border border-gray-300 font-bold text-indigo-700">${d.student}</td>
                            <td class="p-2 border border-gray-300 text-xs">${d.course}</td>
                            <td class="p-2 border border-gray-300 text-xs uppercase">${d.guardian}</td>
                            <td class="p-2 border border-gray-300 text-xs italic">${d.reason}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (e) {
                console.error("Error al generar reporte:", e);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center p-4 text-red-500">Error de conexi√≥n: ' + e.message + '</td></tr>';
            }
        }

        function showMessage(msg, classes) {
            const box = document.getElementById('message-box');
            box.className = `mt-4 p-3 rounded text-center font-bold ${classes}`;
            box.textContent = msg;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 4000);
        }

        function resetForm() {
            document.getElementById('folio').value = '';
            document.getElementById('guardian-name').value = '';
            document.getElementById('guardian-rut').value = '';
            document.getElementById('reason-detail').value = '';
            studentSelect.value = '';
            
            document.getElementById('ticket-area').classList.add('hidden');
            document.getElementById('action-buttons').classList.add('hidden');
            document.getElementById('ticket-placeholder').classList.remove('hidden');
        }

        window.closeReport = () => {
            document.getElementById('report-result').classList.add('hidden');
        };
    </script>
</body>
</html>