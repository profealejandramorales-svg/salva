<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Atrasos v3.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Contenedor Principal */
        .main-wrapper { max-width: 1200px; margin: 0 auto; padding: 2rem; }

        /* Estilos de Tarjetas */
        .card {
            background-color: white; padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: 1px solid #e5e7eb;
        }

        /* --- ESTILOS DE IMPRESI√ìN (VOUCHERS) --- */
        @media print {
            @page { size: Letter portrait; margin: 0.5cm; }
            
            /* Ocultar todo menos el √°rea de impresi√≥n */
            body > *:not(#printable-area) { 
                display: none !important; 
            }

            /* Configuraci√≥n de la cuadr√≠cula de pases (4 por hoja) */
            #printable-area {
                display: grid !important; 
                visibility: visible !important;
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%;
                grid-template-columns: 1fr 1fr; /* 2 columnas */
                grid-auto-rows: 6.2cm; /* Altura ajustada para que quepan 4 y la firma no se salga */
                gap: 0.8cm; /* Espacio entre pases */
                padding: 0.5cm;
            }
            
            #printable-area * { visibility: visible !important; }
            
            /* Estilo de cada Pase Individual */
            .voucher-card {
                border: 2px dashed #666;
                padding: 10px 15px; /* Padding reducido para ganar espacio */
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                background: white;
                break-inside: avoid;
                page-break-inside: avoid;
                height: 100%; /* Ocupar toda la altura de la celda */
            }

            .no-print, #message-box, #print-alert { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <div id="message-box" class="fixed top-5 right-5 bg-blue-600 text-white px-6 py-3 rounded shadow-lg hidden transition-opacity z-50"></div>

    <div class="main-wrapper">
        
        <div class="flex items-center justify-between mb-8 border-b pb-4 bg-white p-4 rounded-xl shadow-sm">
            <div class="flex items-center gap-4">
                <img src="logo.jpg" class="h-16 w-auto object-contain bg-gray-50 rounded-full p-1 border">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Control de Atrasos</h1>
                    <p class="text-xs text-gray-500 font-medium">Escuela Agr√≠cola Sagrados Corazones</p>
                </div>
            </div>
            <div class="text-right">
                <div class="flex gap-2">
                    <button class="bg-red-100 text-red-700 px-4 py-2 rounded font-bold hover:bg-red-200 text-sm transition" id="clear-data-btn">Borrar Historial</button>
                    <button class="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 text-sm transition" id="print-report-btn">Reporte Diario</button>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 font-mono text-right">Desarrollado por ProfeAle</p>
            </div>
        </div>

        <div id="print-alert" class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 hidden rounded shadow-sm">
            <div class="flex">
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 font-bold">‚ö†Ô∏è Recordatorio de Cierre</p>
                    <p class="text-xs text-yellow-600">Recuerda imprimir el reporte diario antes de las 18:00 hrs para el archivo f√≠sico de Inspector√≠a.</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="card border-t-4 border-blue-500">
                <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-4">Registrar Atraso</h2>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Curso</label>
                        <select id="course-select" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none bg-gray-50">
                            <option value="">Selecciona un curso</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estudiante</label>
                        <select id="student-select" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-200 outline-none bg-gray-50" disabled>
                            <option value="">Primero selecciona un curso</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Momento del Atraso</label>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="registro-type" value="Ingreso Ma√±ana" checked class="text-blue-600"> 
                                <span class="font-medium">Ingreso Ma√±ana</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="registro-type" value="1¬∞ Recreo" class="text-blue-600"> 
                                <span>1¬∞ Recreo</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="registro-type" value="2¬∞ Recreo" class="text-blue-600"> 
                                <span>2¬∞ Recreo</span>
                            </label>
                            <label class="flex items-center gap-2 p-2 border rounded hover:bg-blue-50 cursor-pointer">
                                <input type="radio" name="registro-type" value="Ingreso Tarde" class="text-blue-600"> 
                                <span class="font-medium">Ingreso Tarde</span>
                            </label>
                        </div>
                    </div>

                    <button id="add-to-print-list-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow transition transform active:scale-95">
                        Registrar y Generar Pase
                    </button>
                </div>

                <div id="print-list-container" class="mt-6 pt-4 border-t border-dashed hidden">
                    <div class="flex justify-between items-center mb-2 bg-yellow-50 p-2 rounded">
                        <h3 class="font-bold text-yellow-800 text-sm">üéì Pases por Imprimir</h3>
                        <button id="clear-print-list-btn" class="text-xs text-red-500 font-bold hover:underline">Vaciar Cola</button>
                    </div>
                    <ul id="print-list" class="space-y-1 mb-4 text-sm max-h-40 overflow-y-auto"></ul>
                    <button id="print-collective-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z" /></svg>
                        Imprimir Pases (4 por Hoja)
                    </button>
                </div>
            </div>

            <div class="card border-t-4 border-indigo-500 flex flex-col h-full">
                <h2 class="text-lg font-bold text-gray-800 border-b pb-2 mb-2">Bit√°cora Diaria (Hoy)</h2>
                <div class="flex-1 overflow-y-auto max-h-[500px] pr-2">
                    <p id="report-placeholder" class="text-gray-400 italic text-center mt-10 text-sm">No se han registrado atrasos hoy.</p>
                    <table class="w-full text-left text-sm hidden" id="report-table">
                        <thead class="bg-gray-50 sticky top-0 z-10 text-xs uppercase text-gray-500">
                            <tr>
                                <th class="p-2">Hora</th>
                                <th class="p-2">Estudiante</th>
                                <th class="p-2 text-right">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="report-body" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mt-6 bg-gray-50 border-gray-200">
            <h2 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                <span class="bg-gray-200 p-1 rounded">üîé</span> An√°lisis Hist√≥rico
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                <div><label class="text-xs font-bold text-gray-500">Desde</label><input type="date" id="search-date-start" class="w-full p-2 border rounded"></div>
                <div><label class="text-xs font-bold text-gray-500">Hasta</label><input type="date" id="search-date-end" class="w-full p-2 border rounded"></div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Curso</label>
                    <select id="search-course" class="w-full p-2 border rounded"><option value="todos">Todos los cursos</option></select>
                </div>
                <div class="flex items-end">
                    <button id="btn-search" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 rounded shadow">Buscar</button>
                </div>
            </div>

            <div id="analysis-results" class="hidden mt-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-4 rounded border border-red-100 shadow-sm">
                        <h3 class="text-red-600 font-bold text-sm mb-3 border-b pb-1">üî• Top Reincidentes (Periodo)</h3>
                        <ul id="ranking-list" class="text-sm space-y-2"></ul>
                    </div>
                    <div class="md:col-span-2 bg-white p-4 rounded border border-gray-200 shadow-sm overflow-y-auto max-h-60">
                        <h3 class="text-gray-700 font-bold text-sm mb-3 border-b pb-1">Detalle de Registros</h3>
                        <table class="w-full text-xs">
                            <thead class="bg-gray-50"><tr><th class="p-2 text-left">Fecha</th><th class="p-2 text-left">Alumno</th><th class="p-2 text-left">Momento</th></tr></thead>
                            <tbody id="search-results-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="printable-area" class="hidden"></div>

    <script>
        // --- DATOS DEL COLEGIO ---
        const studentsByCourse = {
            'Primero Medio A': ['ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS', 'CONTRERAS SALGADO HADEEY ALEJANDRA', 'FERRADA ALBORNOZ AGUST√çN ALEXIS', 'HERN√ÅNDEZ FERN√ÅNDEZ DHARIEN ALEXSANDER', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA', 'LAGOS LASTRA ALEXANDRA DANAE', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO', 'MALDONADO FLORES ANTONELLA BEL√âN', 'MARIN MAR√çN IGNACIO ANTONIO', 'MONTECINO D√çAZ VALESKA BEL√âN', 'MU√ëOZ CONTRERAS LUIS GABRIEL', 'MU√ëOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ', 'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS', 'QUEZADA NARANJO FELIPE ALONSO', 'QUINTEROS VERGARA FERNANDA FLORENCIA', 'RAM√çREZ VILLALOBOS DUVAN EMILIO', 'SANTANDER L√ìPEZ MAR√çA JOS√â', 'TAPIA CASTILLA JEANFRANCO PATRICK', 'URBINA C√ÅCERES FRANCHESCA POULETTE', 'V√ÅSQUEZ ZALDUENDO AMANDA ISABEL', 'ZABALAGA COFR√â DAMI√ÅN ANDR√âS', 'BAEZ DONOSO LUKAS ALFONSO', 'MESA D√çAZ GONZALO IGNACIO', 'BAREA SALGADO SERGIO ALEXANDER'],
            'Primero Medio B': ['ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MU√ëOZ TRONCOSO H√âCTOR ANTONIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN'],
            'Segundo Medio A': ['AHUMADA ROJAS TRINIDAD BEL√âN', 'ESPINOSA TORRES FERNANDA ELENA', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS', 'GONZ√ÅLEZ SALAZAR EMILIA CATALINA', 'MEDEL OJEDA LE√ìN IGNACIO', 'MORALES REIM√ÅN ALFONSO TOM√ÅS', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO', 'PINTO TOBAR JORD√ÅN AMARO', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO', 'RIVERA ABARZA CONSTANZA VICTORIA', 'SANTIS CASSEUS TEIVA SCARLETT', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN', 'TOLEDO ALBORNOZ ANTONELLA INES', 'VENEGAS ARRIAGADA ANTONIA EDITH', 'VIELMA ZABALAGA JOAN MANUEL', 'MEZA COLIM√ÅN ANGEL BLAS', 'PALMA ORELLANA ANTONELLA FRANCISCA'],
            'Segundo Medio B': ['ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MU√ëOZ TRONCOSO H√âCTOR ANTONIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN'],
            'Tercero Medio A': ['ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA', 'BAHAMONDE MU√ëOZ ARIEL LEON', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS', 'CANCINO OR√ìSTICA VICENTE GASPAR', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA', 'COFR√â CASTILLO ANTONIO ANDR√âS', 'CONTRERAS VENEGAS BEL√âN ALEJANDRA', 'GALDAMES VERGARA FELIPE ESTEBAN', 'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN', 'JARA SEP√öLVEDA KATRINA DARINKA', 'MART√çNEZ LIZANA AARON ALEJANDRO', 'MEZA CARRASCO BENJAM√çN INTI', 'MI√ëO GONZALEZ CATALINA ANDREA', 'MORAGA PACHECO RENATO IGNACIO', 'P√âREZ COR√ìN MANUEL IGNACIO', 'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA', 'TAPIA ACU√ëA GABRIEL ANTONIO', 'VEGA VIVANCO CRIST√ìBAL ANTONIO', 'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA', 'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS', 'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO', 'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'CARO URRUTIA CONSUELO ANTONIA', 'LOBOS C√ÅCERES ANTONIA PAZ'],
            'Tercero Medio C': ['ARELLANO ACU√ëA MART√çN ANTONIO', 'AROS √ÅVILA DAYANA IGNACIA', 'CABRERA COLOMBINO MAR√çA GRACIA', 'FUENTES CARRASCO YARIXA ALEJANDRA', 'G√ìMEZ CANCINO DANIELA ALEJANDRA', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA', 'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAM√çN ESTEBAN', 'PALACIOS SOTO JOS√â TOM√ÅS', 'PEZO SANTANDER JOS√â CRIST√ìBAL', 'ROCHA ROJAS JOS√â PABLO WILLIAMS', 'ROJAS Y√âVENES FABIANA ISIDORA', 'S√ÅNCHEZ PAREJA ANDY ANTONIO', 'SANTANDER L√ìPEZ SIM√ìN ESTEBAN', 'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA', 'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN', 'COLLAO MEDINA ANA√çS VALENTINA'],
            'Cuarto Medio A': ['AGURTO CRESPO HOMERO ALEXANDER', 'ANDIA DE LA HOZ CATALINA BELEN', 'FUENTES GONZ√ÅLEZ ESTEBAN ALEXANDER', 'GARC√çA ROJAS SOF√çA ELENA', 'GODOY HERRERA ANTONELLA CONSTANZA PAZ', 'GONZ√ÅLEZ CASTRO KEVIN ALEJANDRO', 'MARCHANT MOR√ÅN P√çA IGNACIA', 'QUINTANA SAN MART√çN ALAN VICENTE', 'RECABAL Y√Å√ëEZ CRISTOFER BASTI√ÅN', 'ROJAS GONZ√ÅLEZ GABRIEL ANTONIO', 'TOLEDO MU√ëOZ ESPERANZA BEL√âN', 'Y√Å√ëEZ GONZ√ÅLEZ FRANCISCA ALEJANDRA'],
            'Cuarto Medio C': ['Josefa Morales', 'Benjam√≠n P√©rez', 'Constanza Varela'],
        };

        const courseSelect = document.getElementById('course-select');
        const studentSelect = document.getElementById('student-select');
        const searchCourseSelect = document.getElementById('search-course');
        
        let atrasos = JSON.parse(localStorage.getItem('atrasos')) || [];
        let studentsToPrint = [];

        // --- INICIALIZACI√ìN ---
        document.addEventListener('DOMContentLoaded', () => {
            // Llenar selects
            for (const course in studentsByCourse) {
                const opt1 = document.createElement('option'); opt1.value = course; opt1.textContent = course; courseSelect.appendChild(opt1);
                const opt2 = document.createElement('option'); opt2.value = course; opt2.textContent = course; searchCourseSelect.appendChild(opt2);
            }

            // Fechas b√∫squeda
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDay = today.toISOString().split('T')[0];
            document.getElementById('search-date-start').value = firstDay;
            document.getElementById('search-date-end').value = lastDay;

            renderReport();
            showPrintAlert();
        });

        courseSelect.addEventListener('change', () => {
            const selectedCourse = courseSelect.value;
            studentSelect.innerHTML = '<option value="">Selecciona un alumno(a)</option>';
            studentSelect.disabled = !selectedCourse;
            if (selectedCourse && studentsByCourse[selectedCourse]) {
                studentsByCourse[selectedCourse].forEach(student => {
                    const option = document.createElement('option'); option.value = student; option.textContent = student; studentSelect.appendChild(option);
                });
            }
        });

        // --- REGISTRAR ATRASO ---
        document.getElementById('add-to-print-list-btn').addEventListener('click', () => {
            const course = courseSelect.value;
            const student = studentSelect.value;
            const type = document.querySelector('input[name="registro-type"]:checked')?.value;

            if (!course || !student || !type) return showToast('Faltan datos para registrar.');

            const now = new Date();
            const newAtraso = {
                course, student, type,
                time: now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                dateISO: now.toISOString().split('T')[0],
                timestamp: now.toLocaleString()
            };

            atrasos.push(newAtraso);
            localStorage.setItem('atrasos', JSON.stringify(atrasos));
            
            studentsToPrint.push(newAtraso);
            renderStudentsToPrint();
            renderReport();
            studentSelect.value = '';
            showToast('‚úÖ Atraso registrado. Agregado a cola de impresi√≥n.');
        });

        // --- BUSQUEDA ---
        document.getElementById('btn-search').addEventListener('click', () => {
            const start = document.getElementById('search-date-start').value;
            const end = document.getElementById('search-date-end').value;
            const courseFilter = document.getElementById('search-course').value;

            if (!start || !end) return showToast('Selecciona rango de fechas.');

            const filtered = atrasos.filter(a => {
                let recordDate = a.dateISO;
                if (!recordDate) { try { recordDate = new Date(a.timestamp).toISOString().split('T')[0]; } catch(e){ return false; } }
                const matchesDate = recordDate >= start && recordDate <= end;
                const matchesCourse = courseFilter === 'todos' || a.course === courseFilter;
                return matchesDate && matchesCourse;
            });

            if (filtered.length === 0) return showToast('No se encontraron registros.');

            const counts = {};
            filtered.forEach(a => { const key = `${a.student} (${a.course})`; counts[key] = (counts[key] || 0) + 1; });
            const sortedRanking = Object.entries(counts).sort(([,a], [,b]) => b - a).slice(0, 5);

            document.getElementById('analysis-results').classList.remove('hidden');
            
            document.getElementById('search-results-body').innerHTML = filtered.map(a => `
                <tr class="border-b">
                    <td class="p-2">${a.dateISO || '-'}</td>
                    <td class="p-2 font-bold text-gray-700">${a.student}</td>
                    <td class="p-2 text-xs">${a.type}</td>
                </tr>
            `).join('');

            document.getElementById('ranking-list').innerHTML = sortedRanking.map(([name, count], index) => `
                <li class="flex justify-between items-center bg-gray-50 p-2 rounded">
                    <span class="text-xs font-bold text-gray-700 truncate w-3/4">${index + 1}. ${name}</span>
                    <span class="bg-red-100 text-red-700 px-2 rounded-full text-xs font-bold">${count}</span>
                </li>
            `).join('');
        });

        // --- IMPRESI√ìN VOUCHERS (4 POR HOJA) ---
        function renderStudentsToPrint() {
            const list = document.getElementById('print-list');
            const container = document.getElementById('print-list-container');
            list.innerHTML = '';
            
            if (studentsToPrint.length > 0) {
                container.classList.remove('hidden');
                studentsToPrint.forEach((a, idx) => {
                    list.innerHTML += `<li class="flex justify-between border-b pb-1 bg-white p-2 rounded shadow-sm mb-1">
                        <div><span class="font-bold block">${a.student}</span><span class="text-xs text-gray-500">${a.course} - ${a.type}</span></div>
                        <button class="text-red-500 font-bold px-2 hover:bg-red-50 rounded" onclick="removeFromPrint(${idx})">√ó</button>
                    </li>`;
                });
            } else {
                container.classList.add('hidden');
            }
        }

        window.removeFromPrint = (idx) => { studentsToPrint.splice(idx, 1); renderStudentsToPrint(); };
        document.getElementById('clear-print-list-btn').onclick = () => { studentsToPrint = []; renderStudentsToPrint(); };

        document.getElementById('print-collective-btn').onclick = () => {
            if(studentsToPrint.length === 0) return;
            
            const printable = document.getElementById('printable-area');
            printable.innerHTML = ''; 

            studentsToPrint.forEach(s => {
                const card = document.createElement('div');
                card.className = 'voucher-card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #333; padding-bottom:5px; margin-bottom:5px;">
                        <img src="logo.jpg" style="height:45px;">
                        <div style="text-align:right;">
                            <h3 style="margin:0; font-size:16px; font-weight:bold; text-transform:uppercase;">Pase de Ingreso</h3>
                            <p style="margin:0; font-size:10px; color:#555;">INSPECTOR√çA GENERAL</p>
                        </div>
                    </div>
                    
                    <div style="flex-grow:1; display:flex; flex-direction:column; justify-content:center;">
                        <p style="font-size:10px; color:#666; margin-bottom:2px;">ESTUDIANTE:</p>
                        <p style="font-size:14px; font-weight:bold; margin:0 0 6px 0; text-transform:uppercase;">${s.student}</p>
                        
                        <div style="display:flex; gap:10px;">
                            <div style="flex:1;">
                                <p style="font-size:10px; color:#666; margin-bottom:2px;">CURSO:</p>
                                <p style="font-size:12px; font-weight:bold; margin:0;">${s.course}</p>
                            </div>
                            <div style="flex:1;">
                                <p style="font-size:10px; color:#666; margin-bottom:2px;">HORA:</p>
                                <p style="font-size:12px; font-weight:bold; margin:0;">${s.time}</p>
                            </div>
                        </div>
                        
                        <div style="margin-top:8px; padding:4px; background:#f0f0f0; border-radius:4px;">
                            <p style="font-size:9px; color:#666; margin:0;">MOTIVO:</p>
                            <p style="font-size:11px; font-weight:bold; margin:0;">Atraso - ${s.type}</p>
                        </div>
                    </div>

                    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;">
                        <div style="text-align:center;">
                            <div style="border-bottom:1px solid black; width:100px; margin-bottom:2px;"></div>
                            <p style="font-size:9px;">Firma Inspector</p>
                        </div>
                        <p style="font-size:9px; color:#999;">${new Date().toLocaleDateString()}</p>
                    </div>
                `;
                printable.appendChild(card);
            });

            window.print();
            studentsToPrint = []; // Vaciar cola tras imprimir
            renderStudentsToPrint();
        };

        // --- REPORTE DIARIO (LISTADO COMPLETO) ---
        document.getElementById('print-report-btn').onclick = () => {
            const todayStr = new Date().toISOString().split('T')[0];
            // Buscar atrasos del d√≠a (compatible con fecha ISO y string local antiguo)
            const todayData = atrasos.filter(a => (a.dateISO === todayStr) || (a.timestamp.includes(new Date().toLocaleDateString())));
            
            if(todayData.length === 0) return showToast('No hay datos hoy.');

            const printable = document.getElementById('printable-area');
            
            // Generar Tabla HTML
            printable.innerHTML = `
                <div style="width:100%;">
                    <h2 style="text-align:center; margin-bottom:10px; font-size:18px;">REPORTE DIARIO DE ATRASOS</h2>
                    <p style="text-align:center; font-size:12px; margin-bottom:20px;">Fecha: ${new Date().toLocaleDateString()} | Total: ${todayData.length}</p>
                    
                    <table style="width:100%; border-collapse:collapse; font-size:11px; page-break-inside: auto;">
                        <thead style="display: table-header-group;">
                            <tr style="background:#eee;">
                                <th style="border:1px solid #999; padding:6px; text-align:left;">Hora</th>
                                <th style="border:1px solid #999; padding:6px; text-align:left;">Estudiante</th>
                                <th style="border:1px solid #999; padding:6px; text-align:left;">Curso</th>
                                <th style="border:1px solid #999; padding:6px; text-align:left;">Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${todayData.map(a => `
                                <tr style="page-break-inside: avoid; page-break-after: auto;">
                                    <td style="border:1px solid #999; padding:6px;">${a.time}</td>
                                    <td style="border:1px solid #999; padding:6px;">${a.student}</td>
                                    <td style="border:1px solid #999; padding:6px;">${a.course}</td>
                                    <td style="border:1px solid #999; padding:6px;">${a.type}</td>
                                </tr>`).join('')}
                        </tbody>
                    </table>
                    <div style="margin-top:20px; text-align:right; font-size:10px; color:#666;">Generado por ProfeAle System</div>
                </div>
            `;

            // Aplicar estilo temporal para imprimir listado (sobrescribe estilo de vouchers)
            const style = document.createElement('style');
            style.innerHTML = `
                @page { size: Letter; margin: 1cm; } 
                #printable-area { 
                    display: block !important; 
                    position: relative !important;
                    grid-template-columns: none !important;
                    grid-auto-rows: auto !important;
                    gap: 0 !important;
                }
            `;
            document.head.appendChild(style);
            
            window.print();
            
            // Limpiar estilo para volver al modo voucher
            setTimeout(() => document.head.removeChild(style), 1000);
        };

        // Renderizar tabla de reporte en pantalla (Solo de HOY)
        function renderReport() {
            const todayStr = new Date().toISOString().split('T')[0];
            const todayData = atrasos.filter(a => {
                if (a.dateISO) return a.dateISO === todayStr;
                return a.timestamp.includes(new Date().toLocaleDateString());
            });

            const tbody = document.getElementById('report-body');
            const table = document.getElementById('report-table');
            const placeholder = document.getElementById('report-placeholder');

            tbody.innerHTML = '';
            if (todayData.length > 0) {
                placeholder.classList.add('hidden');
                table.classList.remove('hidden');
                todayData.slice().reverse().forEach((a, idx) => {
                    const realIndex = atrasos.indexOf(a); 
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50">
                            <td class="p-2 border-b text-sm font-mono text-blue-600">${a.time}</td>
                            <td class="p-2 border-b">
                                <div class="font-bold text-gray-700 text-xs">${a.student}</div>
                                <div class="text-[10px] text-gray-500">${a.course} ‚Ä¢ ${a.type}</div>
                            </td>
                            <td class="p-2 border-b text-right">
                                <button onclick="deleteItem(${realIndex})" class="text-red-500 text-xs hover:bg-red-50 p-1 rounded">üóëÔ∏è</button>
                            </td>
                        </tr>`;
                });
            } else {
                placeholder.classList.remove('hidden');
                table.classList.add('hidden');
            }
        }

        window.deleteItem = (index) => {
            if(confirm('¬øEliminar este registro?')) {
                atrasos.splice(index, 1);
                localStorage.setItem('atrasos', JSON.stringify(atrasos));
                renderReport();
            }
        };

        document.getElementById('clear-data-btn').onclick = () => {
            if(confirm('¬øBorrar TODO el historial de atrasos? Esta acci√≥n no se puede deshacer.')) {
                localStorage.removeItem('atrasos');
                atrasos = [];
                renderReport();
                showToast('Historial borrado.');
            }
        };

        function showToast(msg) {
            const box = document.getElementById('message-box');
            box.innerText = msg;
            box.classList.remove('hidden');
            setTimeout(() => box.classList.add('hidden'), 3000);
        }

        function showPrintAlert() {
            if (new Date().getHours() >= 17) document.getElementById('print-alert').classList.remove('hidden');
        }
    </script>
</body>
</html>