<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Registro de Atrasos v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; padding: 2rem; }
        
        .main-container {
            display: grid; gap: 2rem; grid-template-columns: 1fr;
            max-width: 1200px; margin: 0 auto;
        }
        @media (min-width: 1024px) {
            .main-container { grid-template-columns: 1fr 1fr; }
            .full-width { grid-column: span 2; }
        }
        
        .card {
            background-color: white; padding: 2rem; border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 1rem;
        }
        
        .header-section {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 1200px; margin: 0 auto 2rem;
        }
        
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-success { background-color: #10b981; color: white; }
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-warning { background-color: #f59e0b; color: white; }
        
        .input-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .input-group label { font-weight: 600; color: #4b5563; }
        .input-group select, .input-group input, .input-group textarea {
            padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #d1d5db;
        }

        /* Message Box */
        .message-box-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 99; display: none; }
        .message-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 2rem; border-radius: 1rem; z-index: 100;
            display: none; flex-direction: column; gap: 1rem; text-align: center; max-width: 400px;
        }

        /* Estilos de tabla an√°lisis */
        .analysis-table th { background-color: #f3f4f6; color: #374151; font-weight: 600; }
        .analysis-table td { border-bottom: 1px solid #e5e7eb; }
        
        @media print {
            @page { size: 80mm 200mm; margin: 0; } /* Ajustado para ticketera t√©rmica si es necesario, o carta */
            body * { visibility: hidden; }
            .printable-content, .printable-content * { visibility: visible; }
            .printable-content {
                position: absolute; left: 0; top: 0; width: 100%;
                font-family: Arial, sans-serif; font-size: 12px; padding: 10px;
            }
        }
    </style>
</head>
<body>

<div class="message-box-overlay" id="message-box-overlay"></div>
<div class="message-box" id="message-box">
    <p id="message-box-text"></p>
    <div class="flex justify-center gap-4 mt-4">
        <button id="message-box-ok" class="btn btn-primary">OK</button>
        <button id="message-box-cancel" class="btn btn-danger hidden">Cancelar</button>
    </div>
</div>

<div class="header-section">
    <h1 class="text-3xl font-bold text-gray-800">Control de Atrasos</h1>
    <div class="flex gap-2">
        <button class="btn btn-danger" id="clear-data-btn">Borrar Todo</button>
        <button class="btn btn-primary" id="print-report-btn">Reporte Diario</button>
    </div>
</div>

<div id="print-alert" class="max-w-[1200px] mx-auto bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 hidden rounded shadow">
    <p class="font-bold">‚ö†Ô∏è Aviso Importante</p>
    <p>Recuerda imprimir el reporte diario de atrasos antes de las 18:00 hrs para el archivo f√≠sico.</p>
</div>

<div class="main-container">
    
    <div class="card">
        <h2 class="text-xl font-bold text-indigo-700 border-b pb-2">Registrar Nuevo Atraso</h2>
        <div class="flex flex-col gap-4">
            <div class="input-group">
                <label>Curso</label>
                <select id="course-select">
                    <option value="">Selecciona un curso</option>
                    </select>
            </div>
            <div class="input-group">
                <label>Alumno(a)</label>
                <select id="student-select" disabled>
                    <option value="">Primero selecciona un curso</option>
                </select>
            </div>
            <div class="input-group">
                <label>Momento del atraso</label>
                <div class="grid grid-cols-2 gap-2 mt-1">
                    <label class="flex items-center gap-2"><input type="radio" name="registro-type" value="Ingreso Ma√±ana" checked> Ingreso Ma√±ana</label>
                    <label class="flex items-center gap-2"><input type="radio" name="registro-type" value="Primer Recreo"> 1¬∞ Recreo</label>
                    <label class="flex items-center gap-2"><input type="radio" name="registro-type" value="Segundo Recreo"> 2¬∞ Recreo</label>
                    <label class="flex items-center gap-2"><input type="radio" name="registro-type" value="Ingreso Tarde"> Ingreso Tarde</label>
                </div>
            </div>
            <button class="btn btn-success w-full" id="add-to-print-list-btn">Registrar y A√±adir a Cola</button>
        </div>

        <div id="print-list-container" class="mt-4 border-t pt-4 hidden">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-gray-600">Cola de Impresi√≥n (Tickets)</h3>
                <button class="text-sm text-red-500 hover:underline" id="clear-print-list-btn">Vaciar</button>
            </div>
            <ul id="print-list" class="space-y-2 text-sm text-gray-700 mb-4"></ul>
            <button class="btn btn-primary w-full" id="print-collective-btn">üñ®Ô∏è Imprimir Tickets Seleccionados</button>
        </div>
    </div>

    <div class="card">
        <h2 class="text-xl font-bold text-indigo-700 border-b pb-2">Registros de HOY</h2>
        <div class="flex-1 overflow-y-auto max-h-[400px]">
            <p id="report-placeholder" class="text-gray-400 italic text-center mt-10">No hay atrasos registrados hoy.</p>
            <table class="w-full text-left text-sm hidden" id="report-table">
                <thead class="bg-gray-50 sticky top-0">
                    <tr>
                        <th class="p-2">Curso / Alumno</th>
                        <th class="p-2">Hora</th>
                        <th class="p-2">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="report-body" class="divide-y divide-gray-100"></tbody>
            </table>
        </div>
    </div>

    <div class="card full-width bg-indigo-50 border border-indigo-100">
        <div class="flex justify-between items-end">
            <div>
                <h2 class="text-xl font-bold text-indigo-800">üîç An√°lisis Hist√≥rico y Conductas</h2>
                <p class="text-sm text-indigo-600">Busca atrasos por fecha y detecta alumnos reincidentes.</p>
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-2">
            <div class="input-group">
                <label class="text-xs uppercase">Desde</label>
                <input type="date" id="search-date-start" class="bg-white">
            </div>
            <div class="input-group">
                <label class="text-xs uppercase">Hasta</label>
                <input type="date" id="search-date-end" class="bg-white">
            </div>
            <div class="input-group">
                <label class="text-xs uppercase">Curso (Opcional)</label>
                <select id="search-course" class="bg-white">
                    <option value="todos">Todos los cursos</option>
                    </select>
            </div>
            <div class="flex items-end">
                <button id="btn-search" class="btn btn-warning w-full shadow-md">Buscar y Analizar</button>
            </div>
        </div>

        <div id="analysis-results" class="hidden mt-6 grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="md:col-span-1 bg-white p-4 rounded shadow-sm border border-gray-200">
                <h3 class="font-bold text-red-600 mb-3 border-b pb-2">üî• Top Reincidentes (Periodo)</h3>
                <ul id="ranking-list" class="text-sm space-y-2">
                    </ul>
            </div>

            <div class="md:col-span-2 bg-white p-4 rounded shadow-sm border border-gray-200 overflow-y-auto max-h-[300px]">
                <h3 class="font-bold text-gray-700 mb-3 border-b pb-2">Detalle de Registros Encontrados</h3>
                <table class="w-full text-sm analysis-table">
                    <thead>
                        <tr>
                            <th class="p-2 text-left">Fecha</th>
                            <th class="p-2 text-left">Alumno</th>
                            <th class="p-2 text-left">Tipo</th>
                        </tr>
                    </thead>
                    <tbody id="search-results-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<script>
    // --- DATOS DEL COLEGIO ---
    const studentsByCourse = {
        'Primero Medio A': ['ALBURQUENQUE DEL GRECCO EMILYA ANTONIA', 'ANABAL√ìN BELTR√ÅN BENJAM√çN NICOL√ÅS', 'CONTRERAS SALGADO HADEEY ALEJANDRA', 'FERRADA ALBORNOZ AGUST√çN ALEXIS', 'HERN√ÅNDEZ FERN√ÅNDEZ DHARIEN ALEXSANDER', 'IB√Å√ëEZ GONZ√ÅLEZ FERNANDA MAGDALENA', 'LAGOS LASTRA ALEXANDRA DANAE', 'L√ìPEZ L√ìPEZ LUCIANO ANTONIO', 'MALDONADO FLORES ANTONELLA BEL√âN', 'MARIN MAR√çN IGNACIO ANTONIO', 'MONTECINO D√çAZ VALESKA BEL√âN', 'MU√ëOZ CONTRERAS LUIS GABRIEL', 'MU√ëOZ LUNA ROGER JOEL', 'NAVARRO VILLANUEVA KARLA PAZ', 'ORELLANA ARRIAGADA SEBASTI√ÅN ANDR√âS', 'QUEZADA NARANJO FELIPE ALONSO', 'QUINTEROS VERGARA FERNANDA FLORENCIA', 'RAM√çREZ VILLALOBOS DUVAN EMILIO', 'SANTANDER L√ìPEZ MAR√çA JOS√â', 'TAPIA CASTILLA JEANFRANCO PATRICK', 'URBINA C√ÅCERES FRANCHESCA POULETTE', 'V√ÅSQUEZ ZALDUENDO AMANDA ISABEL', 'ZABALAGA COFR√â DAMI√ÅN ANDR√âS', 'BAEZ DONOSO LUKAS ALFONSO', 'MESA D√çAZ GONZALO IGNACIO', 'BAREA SALGADO SERGIO ALEXANDER'],
        'Primero Medio B': ['ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MU√ëOZ TRONCOSO H√âCTOR ANTONIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN'],
        'Segundo Medio A': ['AHUMADA ROJAS TRINIDAD BEL√âN', 'ESPINOSA TORRES FERNANDA ELENA', 'ESPINOZA PE√ëALILLO BRAYAN JES√öS', 'GONZ√ÅLEZ SALAZAR EMILIA CATALINA', 'MEDEL OJEDA LE√ìN IGNACIO', 'MORALES REIM√ÅN ALFONSO TOM√ÅS', 'PEREIRA HORMAZ√ÅBAL MAXIMILIANO EDUARDO', 'PINTO TOBAR JORD√ÅN AMARO', 'RECABAL Y√Å√ëEZ KEVIN ANDR√âS', 'RIQUELME CASTILLO MAT√çAS EDUARDO ANTONIO', 'RIVERA ABARZA CONSTANZA VICTORIA', 'SANTIS CASSEUS TEIVA SCARLETT', 'SOBARZO Y√âVENES KATHERINNE ALEXIA BEL√âN', 'TOLEDO ALBORNOZ ANTONELLA INES', 'VENEGAS ARRIAGADA ANTONIA EDITH', 'VIELMA ZABALAGA JOAN MANUEL', 'MEZA COLIM√ÅN ANGEL BLAS', 'PALMA ORELLANA ANTONELLA FRANCISCA'],
        'Segundo Medio B': ['ARAYA DOM√çNGUEZ ALEX FABI√ÅN', 'BRAVO MENARES ALEX JOHAN', 'CARRASCO LEIVA BENJAM√çN IGNACIO', 'CARVAJAL URRUTIA CONSTANZA PRISILA (DANIEL)', 'ENCINA PIZARRO DIEGO BENJAM√çN ALEXANDER', 'FA√öNDEZ NORAMBUENA ALEJANDRO ANTONIO', 'JARAMILLO VILLAR EMILIO SCOTT', 'L√ìPEZ VILLAR MART√çN ALONSO', 'MIRANDA MU√ëOZ ALEXANDRA JAVIERA', 'MU√ëOZ TRONCOSO H√âCTOR ANTONIO', 'OLIVARES VALENZUELA ALONSO IGNACIO', 'OLIVARES VALENZUELA ANTONELLA DANAE IGNACIA', 'ORELLANA GARRIDO MAT√çAS LEANDRO', 'PUNOY MEDEL MILLARAY ANG√âLICA', 'QUI√ëENAO MU√ëOZ CRIST√ìBAL PATRICIO', 'RIQUELME COLOMA DALIA CONSTANZA', 'SALGADO ROJAS VICENTE MOIS√âS', 'SANDOVAL CERPA VICENTE ESTEBAN', 'SOTO NARANJO CHRISTOPHER', 'VEKARIC VERDEJO MART√çN'],
        'Tercero Medio A': ['ALC√ÅNTAR GARC√çA MARTINA ALEJANDRA', 'BAHAMONDE MU√ëOZ ARIEL LEON', 'CAMPOS MU√ëOZ CRISTOPHER JES√öS', 'CANCINO OR√ìSTICA VICENTE GASPAR', 'CARRASCO GONZ√ÅLEZ CAMILA ANDREA', 'COFR√â CASTILLO ANTONIO ANDR√âS', 'CONTRERAS VENEGAS BEL√âN ALEJANDRA', 'GALDAMES VERGARA FELIPE ESTEBAN', 'GARC√çA GONZ√ÅLEZ SANTIAGO HUMBERTO', 'GONZ√ÅLEZ AMIGO FRANCISCA IGNACIA', 'GONZ√ÅLEZ SALAZAR JOAQU√çN ALONSO', 'GUTI√âRREZ GUTI√âRREZ ANGEL MART√çN', 'JARA SEP√öLVEDA KATRINA DARINKA', 'MART√çNEZ LIZANA AARON ALEJANDRO', 'MEZA CARRASCO BENJAM√çN INTI', 'MI√ëO GONZALEZ CATALINA ANDREA', 'MORAGA PACHECO RENATO IGNACIO', 'P√âREZ COR√ìN MANUEL IGNACIO', 'SAMANIEGO CORTEZ JAKSON FERGIE', 'SEP√öLVEDA SALAZAR SOF√çA ANTONIA', 'TAPIA ACU√ëA GABRIEL ANTONIO', 'VEGA VIVANCO CRIST√ìBAL ANTONIO', 'VERA NAVARRETE DANIELA ELIZABETH', 'VILLALOBOS ARAVENA KARINA ANGELINA', 'VILLALOBOS VILLALOBOS SAMIR LUCIAN JES√öS', 'HERN√ÅNDEZ SEP√öLVEDA VICENTE ALEJANDRO', 'TORREALBA MOYA FLORVELIS DE LOS ANGELES', 'CARO URRUTIA CONSUELO ANTONIA', 'LOBOS C√ÅCERES ANTONIA PAZ'],
        'Tercero Medio C': ['ARELLANO ACU√ëA MART√çN ANTONIO', 'AROS √ÅVILA DAYANA IGNACIA', 'CABRERA COLOMBINO MAR√çA GRACIA', 'FUENTES CARRASCO YARIXA ALEJANDRA', 'G√ìMEZ CANCINO DANIELA ALEJANDRA', 'GUTI√âRREZ CARRI√ìN MILLARAY CAROLINA', 'HONORATO TAPIA GLORIA JAVIERA', 'LARA RIVERA BENJAM√çN ESTEBAN', 'PALACIOS SOTO JOS√â TOM√ÅS', 'PEZO SANTANDER JOS√â CRIST√ìBAL', 'ROCHA ROJAS JOS√â PABLO WILLIAMS', 'ROJAS Y√âVENES FABIANA ISIDORA', 'S√ÅNCHEZ PAREJA ANDY ANTONIO', 'SANTANDER L√ìPEZ SIM√ìN ESTEBAN', 'TRONCOSO LIZAMA SIOMARA IGNACIA', 'WARNKEN ROJAS LUCIANA BERNABELA', 'DE LA HOZ VALENZUELA FRANCO SEBASTI√ÅN', 'COLLAO MEDINA ANA√çS VALENTINA'],
        'Cuarto Medio A': ['AGURTO CRESPO HOMERO ALEXANDER', 'ANDIA DE LA HOZ CATALINA BELEN', 'FUENTES GONZ√ÅLEZ ESTEBAN ALEXANDER', 'GARC√çA ROJAS SOF√çA ELENA', 'GODOY HERRERA ANTONELLA CONSTANZA PAZ', 'GONZ√ÅLEZ CASTRO KEVIN ALEJANDRO', 'MARCHANT MOR√ÅN P√çA IGNACIA', 'QUINTANA SAN MART√çN ALAN VICENTE', 'RECABAL Y√Å√ëEZ CRISTOFER BASTI√ÅN', 'ROJAS GONZ√ÅLEZ GABRIEL ANTONIO', 'TOLEDO MU√ëOZ ESPERANZA BEL√âN', 'Y√Å√ëEZ GONZ√ÅLEZ FRANCISCA ALEJANDRA'],
        'Cuarto Medio C': ['Josefa Morales', 'Benjam√≠n P√©rez', 'Constanza Varela'],
    };

    // --- VARIABLES Y DOM ---
    const courseSelect = document.getElementById('course-select');
    const studentSelect = document.getElementById('student-select');
    const searchCourseSelect = document.getElementById('search-course');
    
    // Arrays
    let atrasos = JSON.parse(localStorage.getItem('atrasos')) || [];
    let studentsToPrint = [];

    // --- INICIALIZACI√ìN ---
    document.addEventListener('DOMContentLoaded', () => {
        // Llenar Selects de Cursos
        for (const course in studentsByCourse) {
            const opt1 = document.createElement('option'); opt1.value = course; opt1.textContent = course;
            courseSelect.appendChild(opt1);
            
            const opt2 = document.createElement('option'); opt2.value = course; opt2.textContent = course;
            searchCourseSelect.appendChild(opt2);
        }

        // Fechas por defecto para b√∫squeda (Mes actual)
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        const lastDay = today.toISOString().split('T')[0];
        document.getElementById('search-date-start').value = firstDay;
        document.getElementById('search-date-end').value = lastDay;

        renderReport();
        showPrintAlert();
    });

    // Evento Cambio de Curso (Registro)
    courseSelect.addEventListener('change', () => {
        const selectedCourse = courseSelect.value;
        studentSelect.innerHTML = '<option value="">Selecciona un alumno(a)</option>';
        studentSelect.disabled = !selectedCourse;

        if (selectedCourse && studentsByCourse[selectedCourse]) {
            studentsByCourse[selectedCourse].forEach(student => {
                const option = document.createElement('option');
                option.value = student; option.textContent = student;
                studentSelect.appendChild(option);
            });
        }
    });

    // --- L√ìGICA PRINCIPAL ---

    // 1. REGISTRAR ATRASO
    document.getElementById('add-to-print-list-btn').addEventListener('click', () => {
        const course = courseSelect.value;
        const student = studentSelect.value;
        const type = document.querySelector('input[name="registro-type"]:checked')?.value;

        if (!course || !student || !type) return showMessageBox('Faltan datos.');

        const now = new Date();
        const newAtraso = {
            course, student, type,
            time: now.toLocaleTimeString(),
            timestamp: now.toLocaleString(),
            // IMPORTANTE: Guardamos fecha ISO para poder filtrar despu√©s
            dateISO: now.toISOString().split('T')[0] 
        };

        atrasos.push(newAtraso);
        localStorage.setItem('atrasos', JSON.stringify(atrasos));
        
        studentsToPrint.push(newAtraso);
        renderStudentsToPrint();
        renderReport();
        
        // Reset selecci√≥n estudiante
        studentSelect.value = '';
    });

    // 2. BUSCAR Y ANALIZAR (NUEVO)
    document.getElementById('btn-search').addEventListener('click', () => {
        const start = document.getElementById('search-date-start').value;
        const end = document.getElementById('search-date-end').value;
        const courseFilter = document.getElementById('search-course').value;

        if (!start || !end) return showMessageBox('Selecciona rango de fechas.');

        // Filtrar datos
        const filtered = atrasos.filter(a => {
            // Manejo de compatibilidad para datos antiguos sin dateISO
            let recordDate = a.dateISO;
            if (!recordDate) {
                // Intento simple de extraer fecha de timestamp antiguo si es necesario
                // Pero priorizamos los datos nuevos.
                try { recordDate = new Date(a.timestamp).toISOString().split('T')[0]; } catch(e){ return false; }
            }
            
            const matchesDate = recordDate >= start && recordDate <= end;
            const matchesCourse = courseFilter === 'todos' || a.course === courseFilter;
            return matchesDate && matchesCourse;
        });

        if (filtered.length === 0) return showMessageBox('No se encontraron registros en este periodo.', 'alert');

        // Generar Ranking
        const counts = {};
        filtered.forEach(a => {
            const key = `${a.student} (${a.course})`;
            counts[key] = (counts[key] || 0) + 1;
        });

        // Ordenar Ranking
        const sortedRanking = Object.entries(counts)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 5); // Top 5

        // Renderizar Resultados
        document.getElementById('analysis-results').classList.remove('hidden');
        
        // Tabla Detalle
        const tableBody = document.getElementById('search-results-body');
        tableBody.innerHTML = filtered.map(a => `
            <tr>
                <td class="p-2 border-b">${a.dateISO || a.timestamp.split(',')[0]}</td>
                <td class="p-2 border-b font-bold text-gray-700">${a.student}</td>
                <td class="p-2 border-b text-xs">${a.type}</td>
            </tr>
        `).join('');

        // Lista Ranking
        const rankingList = document.getElementById('ranking-list');
        rankingList.innerHTML = sortedRanking.map(([name, count], index) => `
            <li class="flex justify-between items-center bg-gray-50 p-2 rounded">
                <span class="text-xs font-bold text-gray-700 max-w-[80%] truncate">${index + 1}. ${name}</span>
                <span class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xs font-bold">${count}</span>
            </li>
        `).join('');
    });

    // --- FUNCIONES UTILITARIAS Y DE IMPRESI√ìN (Mantenidas) ---

    function renderStudentsToPrint() {
        const list = document.getElementById('print-list');
        const container = document.getElementById('print-list-container');
        list.innerHTML = '';
        
        if (studentsToPrint.length > 0) {
            container.classList.remove('hidden');
            studentsToPrint.forEach((a, idx) => {
                list.innerHTML += `<li class="flex justify-between border-b pb-1">
                    <span>${a.student}</span>
                    <button class="text-red-500 font-bold" onclick="removeFromPrint(${idx})">√ó</button>
                </li>`;
            });
        } else {
            container.classList.add('hidden');
        }
    }

    window.removeFromPrint = (idx) => { studentsToPrint.splice(idx, 1); renderStudentsToPrint(); };
    
    document.getElementById('clear-print-list-btn').onclick = () => { studentsToPrint = []; renderStudentsToPrint(); };

    // Imprimir Ticket Colectivo
    document.getElementById('print-collective-btn').onclick = () => {
        if(studentsToPrint.length === 0) return;
        const html = `
            <html><head><style>body{font-family:Arial,sans-serif;font-size:12px;}.header{text-align:center;font-weight:bold;margin-bottom:10px;}.line{border-bottom:1px solid #000;margin:5px 0;}</style></head><body>
                <div class="header">CONTROL DE ATRASOS<br>ESC. AGRICOLA SAGRADOS CORAZONES</div>
                <div>Fecha: ${new Date().toLocaleDateString()} Hora: ${new Date().toLocaleTimeString()}</div>
                <div class="line"></div>
                ${studentsToPrint.map(s => `<div><strong>${s.student}</strong><br>${s.course} - ${s.type}</div><hr style="border:0;border-top:1px dashed #ccc;margin:5px 0;">`).join('')}
                <div style="text-align:center;margin-top:20px;">_____________________<br>Firma Inspector√≠a</div>
            </body></html>`;
        printWindow(html);
        studentsToPrint = [];
        renderStudentsToPrint();
    };

    // Imprimir Reporte Diario
    document.getElementById('print-report-btn').onclick = () => {
        const todayStr = new Date().toISOString().split('T')[0];
        const todayData = atrasos.filter(a => (a.dateISO === todayStr) || (a.timestamp.includes(new Date().toLocaleDateString())));
        
        if(todayData.length === 0) return showMessageBox('No hay datos hoy.');

        const html = `
            <html><head><style>body{font-family:Arial;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #000;padding:4px;font-size:10px;}</style></head><body>
                <h3 style="text-align:center">REPORTE DIARIO DE ATRASOS - ${new Date().toLocaleDateString()}</h3>
                <table>
                    <thead><tr><th>Curso</th><th>Alumno</th><th>Tipo</th><th>Hora</th></tr></thead>
                    <tbody>
                        ${todayData.map(a => `<tr><td>${a.course}</td><td>${a.student}</td><td>${a.type}</td><td>${a.time}</td></tr>`).join('')}
                    </tbody>
                </table>
            </body></html>`;
        printWindow(html);
    };

    function printWindow(html) {
        const win = window.open('', '_blank');
        win.document.write(html);
        win.document.close();
        win.onload = () => { win.print(); win.close(); };
    }

    // Renderizar tabla de reporte en pantalla (Solo de HOY)
    function renderReport() {
        const todayStr = new Date().toISOString().split('T')[0];
        // Filtramos para mostrar en el "Reporte Diario" solo lo de hoy
        const todayData = atrasos.filter(a => {
            // Soporte para datos nuevos (dateISO) y antiguos (timestamp string)
            if (a.dateISO) return a.dateISO === todayStr;
            return a.timestamp.includes(new Date().toLocaleDateString());
        });

        const tbody = document.getElementById('report-body');
        const table = document.getElementById('report-table');
        const placeholder = document.getElementById('report-placeholder');

        tbody.innerHTML = '';
        if (todayData.length > 0) {
            placeholder.classList.add('hidden');
            table.classList.remove('hidden');
            todayData.slice().reverse().forEach((a, idx) => { // Mostrar m√°s recientes primero
                // El √≠ndice real en el array original es necesario para borrar
                const realIndex = atrasos.indexOf(a); 
                tbody.innerHTML += `
                    <tr>
                        <td class="p-2 border-b">
                            <div class="font-bold text-gray-700">${a.student}</div>
                            <div class="text-xs text-gray-500">${a.course}</div>
                        </td>
                        <td class="p-2 border-b text-sm">${a.time}</td>
                        <td class="p-2 border-b">
                            <button onclick="deleteItem(${realIndex})" class="text-red-500 text-xs hover:underline">Eliminar</button>
                        </td>
                    </tr>`;
            });
        } else {
            placeholder.classList.remove('hidden');
            table.classList.add('hidden');
        }
    }

    window.deleteItem = (index) => {
        showMessageBox('¬øEliminar registro?', 'confirm', (yes) => {
            if(yes) {
                atrasos.splice(index, 1);
                localStorage.setItem('atrasos', JSON.stringify(atrasos));
                renderReport();
            }
        });
    };

    document.getElementById('clear-data-btn').onclick = () => {
        showMessageBox('¬øBorrar TODO el historial? Irreversible.', 'confirm', (yes) => {
            if(yes) {
                localStorage.removeItem('atrasos');
                atrasos = [];
                renderReport();
            }
        });
    };

    function showMessageBox(msg, type = 'alert', cb) {
        document.getElementById('message-box-text').innerText = msg;
        document.getElementById('message-box-overlay').style.display = 'block';
        document.getElementById('message-box').style.display = 'flex';
        const ok = document.getElementById('message-box-ok');
        const cancel = document.getElementById('message-box-cancel');
        
        cancel.classList.add('hidden');
        
        if (type === 'confirm') {
            cancel.classList.remove('hidden');
            cancel.onclick = () => { closeMsg(); if(cb) cb(false); };
            ok.onclick = () => { closeMsg(); if(cb) cb(true); };
        } else {
            ok.onclick = closeMsg;
        }
    }

    function closeMsg() {
        document.getElementById('message-box-overlay').style.display = 'none';
        document.getElementById('message-box').style.display = 'none';
    }

    function showPrintAlert() {
        if (new Date().getHours() >= 15) document.getElementById('print-alert').classList.remove('hidden');
    }
</script>

</body>
</html>